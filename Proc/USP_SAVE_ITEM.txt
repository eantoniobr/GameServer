SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		TOP
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[USP_SAVE_ITEM] 
	@UID INT,
	@ITEMSTR VARCHAR(8000)
AS
BEGIN
	SET NOCOUNT ON;

	-- INSERT INTO DBO.Pangya_String(str) VALUES(@ITEMSTR)

	DECLARE @TEMP TABLE (STRING VARCHAR(5000), ID INT IDENTITY(1,1))
	DECLARE @sSQL VARCHAR(2000)
	DECLARE @sID INT
	-- THE ITEM DETAIL
	DECLARE @ITEM_IDX VARCHAR(20)
	DECLARE @ITEM_QUANTITY VARCHAR(20)
	DECLARE @ITEM_VALID VARCHAR(20)
	DECLARE @ISUCC VARCHAR(20)
	DECLARE @UCCSTATUS VARCHAR(20)
	DECLARE @UCCUNIQUE VARCHAR(20)

	-- SPLIT
	INSERT INTO @TEMP(STRING) SELECT * FROM STRING_SPLIT(@ITEMSTR, ',') WHERE LEN(VALUE) > 0

	BEGIN TRANSACTION
	BEGIN TRY
		-- INSERT IF EXISTS
		WHILE EXISTS (SELECT * FROM @TEMP) BEGIN
			SELECT TOP 1 @sSQL = REPLACE(STRING, '^', ' ^'), @sID = ID FROM @TEMP
			EXEC XP_SSCANF @sSQL,' ^%s ^%s ^%s ^%s ^%s ^%s', 
			@ITEM_IDX OUTPUT , 
			@ITEM_QUANTITY OUTPUT, 
			@ITEM_VALID OUTPUT, 
			@ISUCC OUTPUT, 
			@UCCSTATUS OUTPUT, 
			@UCCUNIQUE OUTPUT 
			-- SELECT @ITEM_IDX,@ITEM_QUANTITY,@ITEM_VALID,@ISUCC,@UCCSTATUS,@UCCUNIQUE
			-- UPDATE ITEM
			UPDATE DBO.Pangya_Warehouse SET C0 = @ITEM_QUANTITY, VALID = @ITEM_VALID WHERE UID = @UID AND item_id = @ITEM_IDX 
			IF @ISUCC = 1 BEGIN
				UPDATE DBO.Pangya_SelfDesign SET UCC_STATUS = @UCCSTATUS, UCC_UNIQE = @UCCUNIQUE WHERE UID = @UID AND ITEM_ID = @ITEM_IDX 
			END
			DELETE FROM @TEMP WHERE ID = @sID
		END
		-- COMMIT
		COMMIT TRANSACTION
	END TRY
	BEGIN CATCH
		-- ROLLBACK
		ROLLBACK TRANSACTION

		INSERT INTO [DBO].Pangya_Transaction_Log(UID, String, ERROR_NUMBER, ERROR_SEVERITY, ERROR_STATE, ERROR_PROCEDURE, ERROR_LINE, ERROR_MESSAGE)
		SELECT @UID, @ITEMSTR, ERROR_NUMBER(), ERROR_SEVERITY(), ERROR_STATE(), ERROR_PROCEDURE(), ERROR_LINE(), ERROR_MESSAGE()
	END CATCH

END
GO